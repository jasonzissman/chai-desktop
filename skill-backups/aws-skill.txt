const Alexa = require('ask-sdk-core');

// TODO 
// Make intent to answer "what is my id?"
// Make intent to "Generate new id and invalidate old ones"
// Make Launch Intent explain ID options
// Send pending tasks to Alexa app (do not clear!)
// Explain that tasks expire in 1 hour

const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'LaunchRequest';
    },
    handle(handlerInput) {
        // Here, check if an Alexa userId is registered with Chai Tea. If not, prompt
        // the user with a new 6 digit ID that they can write down or see in app.
        
        const speakOutput = 'Welcome to Chai Tea! Simply instruct Alexa to "tell Chai Tea to open XYZ" and I\'ll add it to your feed.';
        const speakOutput2 = `Welcome back to Chai Tea!`;
        return handlerInput.responseBuilder
            .speak(speakOutput)
            .reprompt(speakOutput2)
            .getResponse();
    }
};

const MongoClient = require('mongodb').MongoClient;

const AddToFeedIntentHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
            && Alexa.getIntentName(handlerInput.requestEnvelope) === 'AddToFeedIntent';
    },
    handle(handlerInput) {
        const userId = handlerInput.requestEnvelope.session.user.userId;
        const thingToOpen = handlerInput.requestEnvelope.request.intent.slots.thingToOpen.value;
        const speakOutput = `OK!`;
        
        handlerInput.requestEnvelope.context.callbackWaitsForEmptyEventLoop = false;
        
        MongoClient.connect(uri).then((dbClient) => {
            dbClient.db("smartfeed").collection("smartfeedItems").insertOne({
                userId: userId,
                thingToOpen: thingToOpen,
                created: new Date().getTime()
            }).then(() => {
                dbClient.close();
            });

        });
        
        return handlerInput.responseBuilder
            .speak(speakOutput)
            .getResponse();
    }
};
const HelpIntentHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
            && Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.HelpIntent';
    },
    handle(handlerInput) {
        const speakOutput = 'Simply instruct Alexa to "tell Chai Tea to open XYZ" and I\'ll add it to your feed. You can check your feed with the link that I send to your Alexa app.';

        return handlerInput.responseBuilder
            .speak(speakOutput)
            .reprompt(speakOutput)
            .getResponse();
    }
};
const CancelAndStopIntentHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'IntentRequest'
            && (Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.CancelIntent'
                || Alexa.getIntentName(handlerInput.requestEnvelope) === 'AMAZON.StopIntent');
    },
    handle(handlerInput) {
        const speakOutput = 'Goodbye!';
        return handlerInput.responseBuilder
            .speak(speakOutput)
            .getResponse();
    }
};
const SessionEndedRequestHandler = {
    canHandle(handlerInput) {
        return Alexa.getRequestType(handlerInput.requestEnvelope) === 'SessionEndedRequest';
    },
    handle(handlerInput) {
        // Any cleanup logic goes here.
        return handlerInput.responseBuilder.getResponse();
    }
};

const ErrorHandler = {
    canHandle() {
        return true;
    },
    handle(handlerInput, error) {
        console.log(`~~~~ Error handled: ${error.stack}`);
        const speakOutput = `Sorry, I am having trouble handling requests. Please try again.`;

        return handlerInput.responseBuilder
            .speak(speakOutput)
            .reprompt(speakOutput)
            .getResponse();
    }
};

// The SkillBuilder acts as the entry point for your skill, routing all request and response
// payloads to the handlers above. Make sure any new handlers or interceptors you've
// defined are included below. The order matters - they're processed top to bottom.
exports.handler = Alexa.SkillBuilders.custom()
    .addRequestHandlers(
        LaunchRequestHandler,
        AddToFeedIntentHandler,
        HelpIntentHandler,
        CancelAndStopIntentHandler,
        SessionEndedRequestHandler
    )
    .addErrorHandlers(
        ErrorHandler,
    )
    .lambda();
